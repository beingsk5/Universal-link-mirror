name: SourceForge Link Mirror

permissions:
  contents: write

on:
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Clean SF folder and create anew
        run: |
          rm -rf SF
          mkdir SF

      - name: Install dependencies (axel, gh, unzip, tar)
        run: |
          sudo apt-get update
          sudo apt-get install -y axel unzip tar
          # Install GitHub CLI if not installed
          if ! command -v gh &>/dev/null; then
            type -p curl >/dev/null || sudo apt-get install -y curl
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y gh
          fi

      - name: Download all links from links.txt to SF folder using axel
        run: |
          while IFS= read -r url; do
            filename=$(basename "${url%%\?*}")
            safe_filename=$(echo "$filename" | sed 's/[^a-zA-Z0-9._-]/_/g')
            echo "Downloading $url as $safe_filename"
            axel -n 8 -o "SF/$safe_filename" "$url"
          done < links.txt

      - name: File format validation
        run: |
          for f in SF/*; do
            case "${f##*.}" in
              zip) unzip -t "$f" ;;
              tar) tar -tf "$f" ;;
              *) echo "No validation needed for $f" ;;
            esac
          done

      - name: Generate checksums of downloaded files (no path prefixes)
        run: |
          cd SF
          sha256sum * > ../SF/checks.txt

      - name: Create GitHub Release via CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create mirror-${{ github.run_id }} SF/* --title "Mirrored Files ${{ github.run_id }}" --notes "Automated mirror upload" --draft=false --prerelease=false

      - name: Download release assets for verification
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir SF-verify
          gh release download mirror-${{ github.run_id }} -D SF-verify

      - name: Generate checksums of downloaded release assets (no path prefixes)
        run: |
          cd SF-verify
          sha256sum * > ../SF-verify/checks_downloaded.txt

      - name: Compare checksums to verify upload integrity
        run: |
          diff SF/checks.txt SF-verify/checks_downloaded.txt
