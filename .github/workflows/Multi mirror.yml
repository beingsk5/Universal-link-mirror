name: IDM-like Download & Upload to Release

permissions:
  contents: write
  
on:
  release:
    types: [published]

jobs:
  download-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare downloads directory
        run: mkdir -p downloads

      - name: Download files from links.txt with resume support
        run: |
          while read -r url; do
            echo "Downloading $url"
            filename=$(basename "$url")
            # Use wget with resume (-c) functionality and retry attempts, save in downloads/
            wget -c --tries=10 --retry-connrefused --waitretry=5 -P downloads "$url"
          done < links.txt

      - name: Upload downloaded files to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Upload all downloaded files to the current release by tag name
          files=$(ls downloads)
          for file in $files; do
            echo "Uploading $file to release $GITHUB_REF_NAME"
            gh release upload "$GITHUB_REF_NAME" "downloads/$file"
          done
          
